# compute presc_share_excl_self
# df has columns: npi_id, member_id, is_target_member (0/1)
presc_counts = df.groupby('npi_id')['is_target_member'].sum().rename('presc_treated_count')
presc_total = df.groupby('npi_id')['member_id'].count().rename('presc_total_count')
presc_df = pd.concat([presc_counts, presc_total], axis=1).reset_index()

df = df.merge(presc_df, on='npi_id', how='left')
# leave-one-out numerator and denominator
df['presc_treated_excl'] = df['presc_treated_count'] - df['is_target_member']
df['presc_total_excl'] = df['presc_total_count'] - 1
# avoid divide-by-zero
df['presc_target_share_excl_self'] = df['presc_treated_excl'] / df['presc_total_excl'].replace(0, np.nan)


df['bin'] = pd.cut(df['presc_target_share_excl_self'], bins=np.linspace(0,1,11))
summary = (df.groupby(['bin','is_target_member'])
             .agg(n_members=('member_id','count'),
                  n_prescribers=('npi_id', lambda x: x.nunique()),
                  conv_rate=('EDS_conversion_flag_150d', 'mean'))
             .reset_index())
print(summary)


df['presc_share_c'] = df['presc_target_share_excl_self'] - df['presc_target_share_excl_self'].mean()
gee_formula = "EDS_conversion_flag_150d ~ is_target_member + presc_share_c + is_target_member:presc_share_c + is_new_member"
gee_model = smf.gee(formula=gee_formula, groups="npi_id", data=df,
                   cov_struct=Exchangeable(), family=Binomial())
gee_result = gee_model.fit()
print(gee_result.summary())


from patsy import dmatrix
df['spline_share_1'] = dmatrix("bs(presc_share_c, df=4, include_intercept=False)",
                               data=df, return_type='dataframe')
# or simply include bin dummies from step 2

# R example with fixed effects
library(lmtest)
library(sandwich)
model_fe <- glm(EDS_conversion_flag_150d ~ is_target_member*presc_share_excl_self + is_new_member + factor(npi_id),
                family=binomial(), data=df)
# cluster-robust SE by npi_id
coeftest(model_fe, vcov = vcovCL, cluster = ~npi_id)

