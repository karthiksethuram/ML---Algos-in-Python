# aggregate to prescriber level
pres = df.groupby('npi_id').agg(
    total_members=('EDS_conversion_flag_150d','count'),
    conversion_rate=('EDS_conversion_flag_150d','mean'),
    presc_target_share=('presc_target_share','mean'),
    pct_new=('is_new_member','mean'),
    pct_target=('is_target_member','mean')
).reset_index()

import statsmodels.api as sm
X = pres[['presc_target_share','pct_new','pct_target']]
X = sm.add_constant(X)
y = pres['conversion_rate']

# Use WLS weighted by number of members (more precise prescribers get more weight)
wls = sm.WLS(y, X, weights=pres['total_members']).fit(cov_type='HC3')
print(wls.summary())

# Relationship of presc_target_share noise vs size
import matplotlib.pyplot as plt
import seaborn as sns

# variability of share by total_members
share_by_size = df.groupby('npi_id').agg(total_members=('EDS_conversion_flag_150d','count'),
                                          presc_target_share=('presc_target_share','mean'))
sns.scatterplot(data=share_by_size, x='total_members', y='presc_target_share', alpha=0.6)
plt.xscale('log')
plt.title("Presc target share vs prescriber size (log x)")
plt.show()
