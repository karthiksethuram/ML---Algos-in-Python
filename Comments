import statsmodels.api as sm
from linearmodels.panel import PanelOLS

# Set panel index: prescriber (entity) and unique row
df = df.set_index(["npi_id","experiment_uid"])

# Fixed effects model with prescriber FE
model_full = PanelOLS.from_formula(
    "EDS_conversion_flag_150d ~ is_target_member + presc_target_share_excl_self + "
    "is_target_member:presc_target_share_excl_self + is_new_member + EntityEffects",
    data=df
)
res_full = model_full.fit(cov_type="clustered", cluster_entity=True)
print(res_full.summary)


pure_df = df.loc[
    (df["presc_target_share_excl_self"] == 0) |
    (df["presc_target_share_excl_self"] == 1)
]

model_pure = PanelOLS.from_formula(
    "EDS_conversion_flag_150d ~ is_target_member + presc_target_share_excl_self + "
    "is_target_member:presc_target_share_excl_self + is_new_member + EntityEffects",
    data=pure_df
)
res_pure = model_pure.fit(cov_type="clustered", cluster_entity=True)
print(res_pure.summary)

import matplotlib.pyplot as plt
import numpy as np

# Extract coefficients from the full model
b = res_full.params
b_target   = b["is_target_member"]
b_share    = b["presc_target_share_excl_self"]
b_int      = b["is_target_member:presc_target_share_excl_self"]

share_grid = np.linspace(0,1,50)
control_rate = b_share * share_grid
target_rate  = b_target + (b_share + b_int)*share_grid

plt.figure(figsize=(6,4))
plt.plot(share_grid, control_rate, label="Control")
plt.plot(share_grid, target_rate, label="Target")
plt.xlabel("Prescriber Target Share (excl. self)")
plt.ylabel("Predicted ΔConversion")
plt.title("Marginal Effects: Targeting × Prescriber Exposure")
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()

# Compute prescriber means
presc_means = df.groupby("npi_id")[["EDS_conversion_flag_150d",
                                    "is_target_member",
                                    "presc_target_share_excl_self",
                                    "is_new_member"]].transform("mean")

df_w = df[["EDS_conversion_flag_150d","is_target_member",
           "presc_target_share_excl_self","is_new_member"]] - presc_means

# Regression on de-meaned data
X = sm.add_constant(df_w[["is_target_member",
                          "presc_target_share_excl_self",
                          "is_target_member"]].assign(
                          interaction=df_w["is_target_member"]*df_w["presc_target_share_excl_self"],
                          is_new_member=df_w["is_new_member"]))

y = df_w["EDS_conversion_flag_150d"]
fast_model = sm.OLS(y, X).fit()
print(fast_model.summary())



